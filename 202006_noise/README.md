Reran of realistic noise version 3.1.1 with MSS1 hitmaps 
========================================================

Tag: `mbs-s0011-20200618`

Release date 18 Jun 2020

New noise release using version 3.1.1 of the noise curves from [`so_noise_models`](https://github.com/simonsobs/so_noise_models).

This release fixes an issue with the tube scaling present in the [previous `202002_noise`](https://github.com/simonsobs/map_based_simulations/tree/master/202002_noise) release.

Compared to previous releases:

* Updated noise spectra which include a fix for the atmosphere parameters
* Includes cross-correlations between the 2 bands in the same dichroic tube
* Uses new hitmaps from the `MSS-0001` time domain simulations
* Supports noise splits
* Variable Nside based on channels
* Released in HEALPix and (later) in CAR 

## Input components

All maps are in `uK_CMB`, IQU, single precision (`float32`)

* For the exact configuration of the noise simulations refer to the `noise.toml` configuration file available in this repository.
For all available options refer to the [`SONoiseSimulator` class in `mapsims`](https://mapsims.readthedocs.io/en/latest/api/mapsims.SONoiseSimulator.html#mapsims.SONoiseSimulator).

## Available maps

Only 1 realizations of the full mission and 1 realization of 4 splits are made available as maps.

Reference frame for noise maps is assumed to be **Equatorial**.

**Location at NERSC**:

    /project/projectdirs/sobs/v4_sims/mbs/202006_noise

The naming convention is:

    {num:04d}/simonsobs_{content}_uKCMB_{tube}_{band}_nside{nside}_{num:04d}_{split}_of_{nsplits}.fits"

where:

* `content` is `noise`
* `num` is the realization number (seed) and currently only `0`
* `tube` is `LT0`-`LT6` or `ST0`-`ST3`
* `band` is one of the available bandpasses (available inside `mapsims.so_utils`):

        bands = ("LF1", "LF2", "MFF1", "MFF2", "MFS1", "MFS2", "UHF1", "UHF2")
        frequencies = (27, 39, 93, 145, 93, 145, 225, 280)

* `nsplits` is the number of splits, 1 for full mission, 4 for the splits, `split` is 1 based split ID.

For example: `0000/simonsobs_noise_uKCMB_ST2_MFS2_nside512_0000_1_of_1.fits`

Total disk space used is 548 GB for one realization of full mission and splits.

Backed up to tape in `~zonca/sobs/mbs/202002_noise`.

## Generate other realizations on the fly

More noise realizations should be generated on-the-fly and never written to disk using the `mapsims` package, check the documentation at <https://mapsims.readthedocs.io> for installation instructions.

Then check the [`run_mapsims_onthefly.ipynb`](run_mapsims_onthefly.ipynb) notebook. See also an [executed version of the notebook on Gist](https://gist.github.com/zonca/5d920fe8269831e0d1aecd88ec7d9d50).

## Hitmaps

Hitmaps are used un-normalized to scale the pixel-by-pixel noise.
They are the first split (of 20) of the MSS-0001 time domain simulations, see [their documentation on the Simons Observatory wiki (restricted)](http://simonsobservatory.wikidot.com/mss-0001)
They are available at NERSC in:

    /global/project/projectdirs/sobs/www/so_mapsims_data/v0.2

Or [via web through NERSC](https://portal.nersc.gov/project/sobs/so_mapsims_data/v0.2/)

Or they can be accessed through the `get_hitmaps` method of `mapsims.SONoiseSimulator`.

## Software

* The noise component and the runner script are available in the [`mapsims`](https://github.com/simonsobs/mapsims) package, version 2.3.0, see the [documentation](https://mapsims.readthedocs.io/en/2.1.dev)

## Spectra plots

For validation purposes, see a comparison between the input spectra as generated by `so_noise_models` and a power spectrum (simple `anafast` with no mask deconvolution).

The input spectra assume uniform coverage, so **it is expected that the simulated spectra with non-uniform hits are a bit higher overall**. I don't know exactly how to quantify this or correct for it, suggestions welcome.

Spectra were generated with the `compute_cl_noise_full.py` and `compute_cl_noise_splits.py` scripts and plotted with `plot_cl_noise_LAT_full.ipynb` and `plot_cl_noise_LAT_splits.ipynb`

### LAT Temperature

Blue is the input spectra by `so_noise_models`,
orange and green are TT and BB/EE spectra.
All plots have the same vertical scale.

![LAT T](plots/LAT_T.png)

### LAT Polarization

![LAT P](plots/LAT_P.png)

### LAT Temperature splits

We ran 4-way splits, noise power spectra are 4 times higher

![LAT T splits](plots/LAT_T_splits.png)

### LAT Polarization splits

![LAT P splits](plots/LAT_P_splits.png)

### SAT Temperature

Blue is the input spectra by `so_noise_models`,
orange and green are TT and BB/EE spectra.
All plots have the same vertical scale.

![SAT T](plots/SAT_T.png)

### SAT Polarization

![SAT P](plots/SAT_P.png)
